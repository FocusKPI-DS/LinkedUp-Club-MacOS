<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Content-Security-Policy" content="default-src 'self' https://*.firebaseapp.com https://*.googleapis.com https://*.gstatic.com https://*.firebaseio.com https://*.cloudfunctions.net https://apps.apple.com https://*.firebasestorage.app; manifest-src https://apps.apple.com; img-src 'self' data: https:; script-src 'self' 'unsafe-inline' https://*.gstatic.com; style-src 'self' 'unsafe-inline'; connect-src 'self' https://*.firebaseio.com https://*.googleapis.com https://*.firebaseapp.com https://*.cloudfunctions.net;">
  <title>Join Lona - Invite Link</title>
  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 100vh;
      padding: 20px;
      text-align: center;
      background-image: url('/lona-workspace.png');
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      position: relative;
    }
    body::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 0;
    }
    .container {
      max-width: 420px;
      width: 100%;
      position: relative;
      z-index: 1;
      background: rgba(255, 255, 255, 0.98);
      border-radius: 24px;
      padding: 40px 32px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(10px);
    }
    .referrer-info {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 32px;
    }
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 4px solid #007AFF;
      margin-bottom: 16px;
      background: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 40px;
      font-weight: 600;
      color: #007AFF;
      overflow: hidden;
    }
    .avatar img {
      width: 100%;
      height: 100%;
      border-radius: 50%;
      object-fit: cover;
    }
    .referrer-name {
      font-size: 24px;
      font-weight: 700;
      color: #000000;
      margin-bottom: 8px;
    }
    .invite-text {
      font-size: 16px;
      color: #666666;
      margin-bottom: 0;
    }
    .buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 32px;
    }
    .btn {
      width: 100%;
      padding: 16px 24px;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-block;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }
    .btn-primary {
      background: #007AFF;
      color: white;
    }
    .btn-primary:hover {
      background: #0056CC;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
    }
    .btn-secondary {
      background: white;
      color: #007AFF;
      border: 2px solid #007AFF;
    }
    .btn-secondary:hover {
      background: #f0f7ff;
      transform: translateY(-1px);
    }
    .btn:active {
      transform: translateY(0);
    }
    .loading {
      opacity: 0.6;
      pointer-events: none;
    }
    .loading .btn {
      opacity: 0.6;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="referrer-info" id="referrerInfo">
      <div class="avatar" id="avatar">
        <span id="avatarInitials">?</span>
      </div>
      <div class="referrer-name" id="referrerName">Loading...</div>
      <div class="invite-text">invited you to join Lona</div>
    </div>
    
    <div class="buttons" id="buttons">
      <button class="btn btn-primary" id="appStoreBtn" onclick="goToAppStore()">
        Continue to App Store
      </button>
      <button class="btn btn-secondary" id="webAppBtn" onclick="goToWebApp()">
        Continue on Web
      </button>
    </div>
  </div>

  <script>
    (function() {
      // Initialize Firebase
      const firebaseConfig = {
        apiKey: "AIzaSyB7hpucMa-mSk6Bp9_OOt_1BFaO7E7HPTw",
        authDomain: "linkedup-c3e29.firebaseapp.com",
        projectId: "linkedup-c3e29",
        storageBucket: "linkedup-c3e29.firebasestorage.app",
        messagingSenderId: "548534727055",
        appId: "1:548534727055:web:d770e39d4c066094bb5bfa"
      };
      
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();

      // Extract UID from URL path
      const path = window.location.pathname;
      const match = path.match(/\/invite\/([^\/\?]+)/);
      const uid = match ? match[1] : null;

      if (!uid) {
        window.location.href = '/';
        return;
      }

      // Store referral UID in localStorage (for both app and web)
      try {
        localStorage.setItem('pending_referrer_uid', uid);
        console.log('Stored referral UID:', uid);
      } catch (e) {
        console.log('Could not store referral UID:', e);
      }

      // Fetch referrer user data
      async function loadReferrerInfo() {
        try {
          console.log('Loading referrer info for UID:', uid);
          const userDoc = await db.collection('users').doc(uid).get();
          console.log('User doc exists:', userDoc.exists);
          
          if (userDoc.exists) {
            const userData = userDoc.data();
            console.log('User data:', userData);
            
            const displayName = userData.display_name || userData.email || 'Someone';
            const photoUrl = userData.photo_url || '';
            
            console.log('Display name:', displayName, 'Photo URL:', photoUrl);
            
            const referrerInfo = document.getElementById('referrerInfo');
            const referrerNameEl = document.getElementById('referrerName');
            const avatarEl = document.getElementById('avatar');
            const avatarInitialsEl = document.getElementById('avatarInitials');
            
            referrerNameEl.textContent = displayName;
            
            // Get initials for avatar fallback
            const nameParts = displayName.trim().split(/\s+/);
            const initials = nameParts.length > 0 
              ? nameParts.map(n => n[0]).join('').toUpperCase().substring(0, 2)
              : '?';
            avatarInitialsEl.textContent = initials;
            
            // Clear any existing images
            const existingImg = avatarEl.querySelector('img');
            if (existingImg) {
              existingImg.remove();
            }
            
            // Load profile photo if available
            if (photoUrl && photoUrl.trim() !== '') {
              const img = document.createElement('img');
              img.src = photoUrl;
              img.onerror = function() {
                console.log('Image failed to load, showing initials');
                img.style.display = 'none';
                avatarInitialsEl.style.display = 'flex';
              };
              img.onload = function() {
                console.log('Image loaded successfully');
                avatarInitialsEl.style.display = 'none';
              };
              avatarEl.insertBefore(img, avatarInitialsEl);
            } else {
              avatarInitialsEl.style.display = 'flex';
            }
            
            referrerInfo.style.display = 'flex';
            console.log('Referrer info displayed');
          } else {
            console.log('User document does not exist');
            document.getElementById('referrerInfo').style.display = 'none';
          }
        } catch (error) {
          console.error('Error loading referrer info:', error);
          document.getElementById('referrerInfo').style.display = 'none';
        }
      }
      
      // Load referrer info immediately
      loadReferrerInfo();

      // App Store URL
      window.appStoreUrl = 'https://apps.apple.com/us/app/lona-club/id6747595642';
      
      // Web app URL
      window.webAppUrl = 'https://lona.club/app';
      
      // Function to go to App Store
      window.goToAppStore = function() {
        const userAgent = navigator.userAgent || navigator.vendor || window.opera;
        const isIOS = /iPad|iPhone|iPod/.test(userAgent) && !window.MSStream;
        const isAndroid = /android/i.test(userAgent);
        
        // Try Universal Link/App Link first
        if (isIOS || isAndroid) {
          const appLink = 'lona://invite/' + uid;
          try {
            const iframe = document.createElement('iframe');
            iframe.style.display = 'none';
            iframe.style.width = '0';
            iframe.style.height = '0';
            iframe.src = appLink;
            document.body.appendChild(iframe);
            setTimeout(function() {
              if (iframe.parentNode) {
                iframe.parentNode.removeChild(iframe);
              }
            }, 100);
          } catch (e) {
            console.log('App Link attempt failed:', e);
          }
        }
        
        // Redirect to App Store
        window.location.href = window.appStoreUrl;
      };
      
      // Function to go to Web App
      window.goToWebApp = function() {
        // Store referral UID in URL parameter as well (for web app to read)
        const webUrl = window.webAppUrl + '?referrer=' + uid;
        window.location.href = webUrl;
      };
    })();
  </script>
</body>
</html>
